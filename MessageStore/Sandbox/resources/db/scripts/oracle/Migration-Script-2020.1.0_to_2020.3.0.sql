/*
 * Changes:
 * 1. Created tagging tables which will be used to support message playback.
 * 2. Add the current message store schema version
 */


/*
* ************** 1. Create message tagging related schema ****************
*/

CREATE TABLE MS_TAG
(
    TAG_ID      NUMERIC(16) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
	TAG_NAME    VARCHAR2(255) NOT NULL,
    CREATED_AT  TIMESTAMP   NOT NULL
);

ALTER TABLE MS_TAG ADD CONSTRAINT TAG_ID_PK PRIMARY KEY ( TAG_ID );

ALTER TABLE MS_TAG ADD CONSTRAINT TAG_UK UNIQUE ( TAG_NAME );

COMMENT ON TABLE MS_TAG IS
    'Table that maintains tags for grouping messages';

CREATE TABLE MS_MSG_TAG
(
    MS_TAG_ID       NUMERIC(16) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
	TAG_ID          NUMERIC(16) NOT NULL,
	MSG_HDR_ID      NUMERIC(16) NOT NULL,
    CREATED_AT      TIMESTAMP   NOT NULL
);

ALTER TABLE MS_MSG_TAG ADD CONSTRAINT MS_TAG_ID_PK PRIMARY KEY ( MS_TAG_ID );

ALTER TABLE MS_MSG_TAG ADD CONSTRAINT MSG_TAG_UK UNIQUE ( TAG_ID, MSG_HDR_ID );

ALTER TABLE MS_MSG_TAG ADD CONSTRAINT TAG_FK FOREIGN KEY ( TAG_ID ) REFERENCES MS_TAG ( TAG_ID ) ON DELETE CASCADE;

ALTER TABLE MS_MSG_TAG ADD CONSTRAINT MSG_HDR_FK FOREIGN KEY (MSG_HDR_ID ) REFERENCES MS_MSG_HDR ( MSG_HDR_ID ) ON DELETE CASCADE;

COMMENT ON TABLE MS_MSG_TAG IS
    'Table that assigns messages to tag';

/*
* ************** 2. Add the current message store schema version. ****************
*/
INSERT INTO MS_VER(VER, CRTD_AT) VALUES('2020.3.0', CURRENT_TIMESTAMP);
COMMIT;
